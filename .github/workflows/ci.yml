name: CI
on: [push, pull_request]

jobs:
  lint:
    name: "ğŸ¨ Lint & Format"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Solana CLI
        run: |
          echo "âš™ï¸ Installing Solana CLI..."
          set -e
          sh -c "$(curl -sSfL https://release.solana.com/v1.18.26/install)" || {
            echo "âŒ Failed to install Solana CLI"
            exit 1
          }
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version || {
            echo "âŒ Failed to verify Solana CLI installation"
            exit 1
          }
          echo "âœ… Solana CLI installed and verified successfully"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            node_modules
            sdk/node_modules
            cli/node_modules
            frontend/node_modules
          key: ${{ runner.os }}-lint-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-lint-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing workspace dependencies for linting..."
          set -e
          
          echo "ğŸ”§ Installing root dependencies..."
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install root dependencies"
            exit 1
          }
          echo "âœ… Root dependencies installed successfully"
          
          echo "ğŸ”§ Installing SDK dependencies..."
          cd sdk
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install SDK dependencies"
            exit 1
          }
          echo "âœ… SDK dependencies installed successfully"
          
          echo "ğŸ”§ Installing CLI dependencies..."
          cd ../cli
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install CLI dependencies"
            exit 1
          }
          echo "âœ… CLI dependencies installed successfully"
          
          echo "ğŸ”§ Installing frontend dependencies..."
          cd ../frontend
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install frontend dependencies"
            exit 1
          }
          echo "âœ… Frontend dependencies installed successfully"
          echo "ğŸ‰ All dependencies installed successfully"

      - name: Lint TypeScript & Prettier
        run: |
          echo "ğŸ¨ Running TypeScript and Prettier linting..."
          set -e
          bun run lint:all || {
            echo "âŒ TypeScript and Prettier linting failed"
            exit 1
          }
          echo "âœ… TypeScript and Prettier linting passed"

      - name: Lint Frontend
        run: |
          echo "ğŸ¨ Running frontend linting..."
          set -e
          cd frontend
          bun run lint || {
            echo "âŒ Frontend linting failed"
            exit 1
          }
          echo "âœ… Frontend linting passed"

      - name: Lint Rust
        run: |
          echo "ğŸ¦€ Running Rust linting..."
          set -e
          cd programs/pod-com
          
          echo "ğŸ”§ Checking Rust formatting..."
          cargo fmt -- --check || {
            echo "âŒ Rust formatting check failed"
            exit 1
          }
          echo "âœ… Rust formatting check passed"
          
          echo "ğŸ”§ Running Rust clippy..."
          cargo clippy -- -D warnings || {
            echo "âŒ Rust clippy check failed"
            exit 1
          }
          echo "âœ… Rust clippy check passed"

  security-audit:
    name: "ğŸ”’ Security Audit (LOW-01)"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: |
          echo "ğŸ”’ Installing cargo-audit..."
          set -e
          cargo install cargo-audit --locked || {
            echo "âŒ Failed to install cargo-audit"
            exit 1
          }
          echo "âœ… cargo-audit installed successfully"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            node_modules
            sdk/node_modules
            cli/node_modules
            frontend/node_modules
          key: ${{ runner.os }}-security-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-security-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing workspace dependencies for security audit..."
          set -e
          
          echo "ğŸ”§ Installing root dependencies..."
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install root dependencies"
            exit 1
          }
          echo "âœ… Root dependencies installed successfully"
          
          echo "ğŸ”§ Installing SDK dependencies..."
          cd sdk
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install SDK dependencies"
            exit 1
          }
          echo "âœ… SDK dependencies installed successfully"
          
          echo "ğŸ”§ Installing CLI dependencies..."
          cd ../cli
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install CLI dependencies"
            exit 1
          }
          echo "âœ… CLI dependencies installed successfully"
          
          echo "ğŸ”§ Installing frontend dependencies..."
          cd ../frontend
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install frontend dependencies"
            exit 1
          }
          echo "âœ… Frontend dependencies installed successfully"
          echo "ğŸ‰ All dependencies installed successfully"

      - name: Rust Security Audit
        run: |
          echo "ğŸ”’ Running Rust security audit..."
          set -e
          cd programs/pod-com
          cargo audit --deny warnings || {
            echo "âŒ Rust security audit failed"
            exit 1
          }
          echo "âœ… Rust security audit passed"

      - name: Node.js Security Audit (Root)
        run: |
          echo "ğŸ”’ Running Node.js security audit for root workspace..."
          set -e
          bun audit --audit-level high || {
            echo "âŒ Root workspace security audit failed"
            exit 1
          }
          echo "âœ… Root workspace security audit passed"

      - name: Node.js Security Audit (SDK)
        run: |
          echo "ğŸ”’ Running Node.js security audit for SDK..."
          set -e
          cd sdk
          bun audit --audit-level high || {
            echo "âŒ SDK security audit failed"
            exit 1
          }
          echo "âœ… SDK security audit passed"

      - name: Node.js Security Audit (CLI)
        run: |
          echo "ğŸ”’ Running Node.js security audit for CLI..."
          set -e
          cd cli
          bun audit --audit-level high || {
            echo "âŒ CLI security audit failed"
            exit 1
          }
          echo "âœ… CLI security audit passed"

      - name: Node.js Security Audit (Frontend)
        run: |
          echo "ğŸ”’ Running Node.js security audit for Frontend..."
          set -e
          cd frontend
          bun audit --audit-level high || {
            echo "âŒ Frontend security audit failed"
            exit 1
          }
          echo "âœ… Frontend security audit passed"

      - name: npm Security Audit
        run: |
          echo "ğŸ”’ Running npm audit for all workspaces..."
          set -e
          for dir in . sdk cli frontend; do
            if [ -f "$dir/package.json" ]; then
              echo "ğŸ“¦ Auditing $dir..."
              cd $dir
              npm install --package-lock-only --ignore-scripts || {
                echo "âŒ Failed to create package-lock.json for $dir"
                exit 1
              }
              npm audit --audit-level=high || {
                echo "âŒ npm security audit failed for $dir"
                exit 1
              }
              echo "âœ… npm security audit passed for $dir"
              cd ..
            fi
          done
          echo "ğŸ‰ All npm security audits completed successfully"

      - name: Check for known vulnerabilities in dependencies
        run: |
          echo "ğŸ” Checking for vulnerable patterns in code..."
          # Check for common security anti-patterns
          if grep -r --include="*.ts" --include="*.js" --include="*.rs" -n "eval\|innerHTML\|dangerouslySetInnerHTML" . ; then
            echo "âš ï¸ Warning: Found potentially dangerous patterns. Review for security implications."
          fi
          
          # Check for hardcoded secrets (basic patterns)
          if grep -r --include="*.ts" --include="*.js" --include="*.rs" -i "password\|secret\|key\|token" . | grep -v "test\|example\|placeholder" | grep "=" ; then
            echo "âš ï¸ Warning: Found potential hardcoded credentials. Review for security implications."
          fi
          
          echo "âœ… Security pattern check completed"

  build:
    name: "ğŸ—ï¸ Build All"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          echo "ğŸ“¦ Installing system dependencies for build..."
          set -e
          sudo apt-get update || {
            echo "âŒ Failed to update package lists"
            exit 1
          }
          sudo apt-get install -y pkg-config build-essential libudev-dev || {
            echo "âŒ Failed to install system dependencies"
            exit 1
          }
          echo "âœ… System dependencies installed successfully"

      - name: Install Anchor CLI via avm
        run: |
          echo "âš™ï¸ Installing Anchor CLI for build..."
          set -e
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force || {
            echo "âŒ Failed to install AVM"
            exit 1
          }
          avm install 0.31.1 || {
            echo "âŒ Failed to install Anchor version 0.31.1"
            exit 1
          }
          avm use 0.31.1 || {
            echo "âŒ Failed to use Anchor version 0.31.1"
            exit 1
          }
          echo "âœ… Anchor CLI installed and configured successfully"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            target
            node_modules
            sdk/node_modules
            cli/node_modules
          key: ${{ runner.os }}-build-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing workspace dependencies for build..."
          set -e
          
          echo "ğŸ”§ Installing root dependencies..."
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install root dependencies"
            exit 1
          }
          echo "âœ… Root dependencies installed successfully"
          
          echo "ğŸ”§ Installing frontend dependencies..."
          cd frontend
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install frontend dependencies"
            exit 1
          }
          echo "âœ… Frontend dependencies installed successfully"
          echo "ğŸ‰ All dependencies installed successfully"

      - name: Build Solana Program
        run: |
          echo "âš“ Building Anchor program..."
          set -e
          anchor build || {
            echo "âŒ Failed to build Anchor program"
            exit 1
          }
          echo "âœ… Anchor program built successfully"

      - name: Build SDK
        run: |
          echo "ğŸ“¦ Building SDK..."
          set -e
          cd sdk
          bun run build || {
            echo "âŒ Failed to build SDK"
            exit 1
          }
          echo "âœ… SDK built successfully"

      - name: Build CLI
        run: |
          echo "ğŸ”§ Building CLI..."
          set -e
          cd cli
          bun run build || {
            echo "âŒ Failed to build CLI"
            exit 1
          }
          echo "âœ… CLI built successfully"

      - name: Build Frontend
        run: |
          echo "ğŸŒ Building Frontend..."
          set -e
          cd frontend
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install frontend dependencies"
            exit 1
          }
          bun run build || {
            echo "âŒ Failed to build frontend"
            exit 1
          }
          echo "âœ… Frontend built successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target/deploy/
            target/idl/
            sdk/dist/
            cli/dist/
            frontend/.next/

  test:
    name: "ğŸ§ª Test Suite"
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          echo "ğŸ“¦ Installing system dependencies for testing..."
          set -e
          sudo apt-get update || {
            echo "âŒ Failed to update package lists"
            exit 1
          }
          sudo apt-get install -y pkg-config build-essential libudev-dev netcat-openbsd curl || {
            echo "âŒ Failed to install system dependencies"
            exit 1
          }
          echo "âœ… System dependencies installed successfully"

      - name: Install Anchor CLI via avm
        run: |
          echo "âš™ï¸ Installing Anchor CLI for testing..."
          set -e
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force || {
            echo "âŒ Failed to install AVM"
            exit 1
          }
          avm install 0.31.1 || {
            echo "âŒ Failed to install Anchor version 0.31.1"
            exit 1
          }
          avm use 0.31.1 || {
            echo "âŒ Failed to use Anchor version 0.31.1"
            exit 1
          }
          echo "âœ… Anchor CLI installed and configured successfully"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cargo/registry
            ~/.cargo/git
            node_modules
            sdk/node_modules
            cli/node_modules
          key: ${{ runner.os }}-test-${{ hashFiles('**/bun.lock', '**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-test-

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing workspace dependencies for testing..."
          set -e
          
          echo "ğŸ”§ Installing root dependencies..."
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install root dependencies"
            exit 1
          }
          echo "âœ… Root dependencies installed successfully"
          
          echo "ğŸ”§ Installing frontend dependencies..."
          cd frontend
          bun install --frozen-lockfile || {
            echo "âŒ Failed to install frontend dependencies"
            exit 1
          }
          echo "âœ… Frontend dependencies installed successfully"
          echo "ğŸ‰ All dependencies installed successfully"

      - name: Setup Solana keypair
        run: |
          echo "ğŸ”‘ Setting up Solana keypair..."
          set -e
          mkdir -p ~/.config/solana || {
            echo "âŒ Failed to create Solana config directory"
            exit 1
          }
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json || {
            echo "âŒ Failed to generate Solana keypair"
            exit 1
          }
          solana config set --url localhost || {
            echo "âŒ Failed to configure Solana URL"
            exit 1
          }
          echo "âœ… Solana keypair and configuration setup successfully"

      - name: Start and Wait for Solana Test Validator
        run: |
          echo "ğŸš€ Starting Solana test validator..."
          solana-test-validator --reset --quiet --log /tmp/validator.log &
          VALIDATOR_PID=$!
          echo "Validator PID: $VALIDATOR_PID"
          
          echo "â³ Waiting for validator to be ready..."
          for i in {1..60}; do
            if nc -z localhost 8899 && nc -z localhost 8900; then
              echo "âœ… Validator is ready on ports 8899 (RPC) and 8900 (WebSocket)"
              
              # Additional health check
              if curl -s -X POST -H "Content-Type: application/json" \
                -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}' \
                http://localhost:8899 | grep -q '"result":"ok"'; then
                echo "âœ… Validator health check passed"
                break
              fi
            fi
            
            if [ $i -eq 60 ]; then
              echo "âŒ Validator did not start within 60 seconds"
              echo "ğŸ“‹ Validator logs:"
              if [ -f /tmp/validator.log ]; then
                tail -50 /tmp/validator.log
              fi
              kill $VALIDATOR_PID 2>/dev/null || true
              exit 1
            fi
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "â³ Attempt $i/60: Still waiting for validator..."
            fi
            sleep 1
          done

      - name: Run Anchor Tests
        run: |
          echo "ğŸ§ª Running Anchor tests..."
          set -e
          anchor test --skip-build || {
            echo "âŒ Anchor tests failed"
            exit 1
          }
          echo "âœ… Anchor tests passed"

      - name: Run SDK & CLI Tests
        run: |
          echo "ğŸ§ª Running SDK & CLI tests..."
          set -e
          bun run test || {
            echo "âŒ SDK & CLI tests failed"
            exit 1
          }
          echo "âœ… SDK & CLI tests passed"

      - name: Run Compute Unit Benchmarks
        run: |
          echo "âš¡ Running compute unit benchmarks..."
          set -e
          if [ -f tests/performance-benchmark.test.ts ]; then
            echo "ğŸ“Š Found performance benchmark, running..."
            cd tests
            bun run performance-benchmark.test.ts || {
              echo "âŒ Performance benchmark failed"
              exit 1
            }
            echo "âœ… Performance benchmark completed"
            cd ..
          else
            echo "â„¹ï¸  No performance benchmark found, skipping..."
          fi

      - name: Stop Solana test validator
        run: |
          echo "ğŸ›‘ Stopping Solana test validator..."
          pkill -f solana-test-validator || echo "â„¹ï¸  No validator process found to stop"
          echo "âœ… Validator cleanup completed"
